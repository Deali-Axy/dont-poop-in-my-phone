name: æŒç»­é›†æˆæ£€æŸ¥

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  analyze:
    name: ä»£ç åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Flutterç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
      
      - name: è·å–Flutterä¾èµ–
        run: flutter pub get
      
      - name: è¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: è¿è¡Œé™æ€åˆ†æ
        run: |
          echo "è¿è¡Œé™æ€ä»£ç åˆ†æ..."
          flutter analyze
      
      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
          flutter test --coverage
      
      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v4
        if: success()
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false

  build-test:
    name: æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: è®¾ç½®Flutterç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
      
      - name: è·å–Flutterä¾èµ–
        run: flutter pub get
      
      - name: è¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: æ„å»ºDebug APK
        run: |
          echo "æ„å»ºDebug APKè¿›è¡Œæµ‹è¯•..."
          flutter build apk --debug
      
      - name: æ£€æŸ¥APKå¤§å°
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            APK_SIZE_BYTES=$(du -b "$APK_PATH" | cut -f1)
            echo "APKå¤§å°: $APK_SIZE ($APK_SIZE_BYTES bytes)"
            
            # æ£€æŸ¥APKå¤§å°æ˜¯å¦è¶…è¿‡é˜ˆå€¼ (100MB)
            MAX_SIZE_BYTES=104857600
            if [ "$APK_SIZE_BYTES" -gt "$MAX_SIZE_BYTES" ]; then
              echo "âš ï¸ è­¦å‘Š: APKå¤§å° ($APK_SIZE) è¶…è¿‡100MBé˜ˆå€¼"
              echo "APK_SIZE_WARNING=true" >> $GITHUB_ENV
            else
              echo "âœ… APKå¤§å°æ­£å¸¸"
            fi
            
            echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
            echo "APK_SIZE_BYTES=$APK_SIZE_BYTES" >> $GITHUB_ENV
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi
      
      - name: æ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸ“Š æ„å»ºæµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APKä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- å¤§å°: ${{ env.APK_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- å­—èŠ‚æ•°: ${{ env.APK_SIZE_BYTES }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.APK_SIZE_WARNING }}" = "true" ]; then
            echo "- âš ï¸ å¤§å°è­¦å‘Š: è¶…è¿‡100MBé˜ˆå€¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… å¤§å°æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ä¸Šä¼ Debug APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: debug-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 3

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è¿è¡Œå®‰å…¨æ‰«æ
        uses: securecodewarrior/github-action-add-sarif@v1
        if: false  # æš‚æ—¶ç¦ç”¨ï¼Œéœ€è¦é…ç½®SARIF
        with:
          sarif-file: 'security-scan-results.sarif'
      
      - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        run: |
          echo "æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥æˆ–å¯†ç 
          if grep -r -i "password\|secret\|key\|token" --include="*.dart" --include="*.yaml" --include="*.json" . | grep -v "pubspec.lock" | grep -v ".git"; then
            echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ–‡ä»¶"
          else
            echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•ä»£ç 
          if grep -r "print(" --include="*.dart" lib/ | head -10; then
            echo "âš ï¸ å‘ç°è°ƒè¯•printè¯­å¥ï¼Œå»ºè®®åœ¨å‘å¸ƒå‰ç§»é™¤"
          fi