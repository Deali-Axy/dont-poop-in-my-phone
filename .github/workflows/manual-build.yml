name: æ‰‹åŠ¨æž„å»ºAPK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      target_platform:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android-arm64
          - android-arm
          - android-x64
          - universal
      version_suffix:
        description: 'ç‰ˆæœ¬åŽç¼€ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string

jobs:
  manual-build:
    name: æ‰‹åŠ¨æž„å»ºAPK
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®JavaçŽ¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: è®¾ç½®FlutterçŽ¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
      
      - name: èŽ·å–Flutterä¾èµ–
        run: flutter pub get
      
      - name: è¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: æž„å»ºAPK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          TARGET_PLATFORM="${{ github.event.inputs.target_platform }}"
          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          
          if [ "$BUILD_TYPE" = "debug" ]; then
            BUILD_FLAG="--debug"
          else
            BUILD_FLAG="--release"
          fi
          
          case "$TARGET_PLATFORM" in
            "all")
              echo "æž„å»ºæ‰€æœ‰å¹³å°APK..."
              flutter build apk $BUILD_FLAG --split-per-abi
              flutter build apk $BUILD_FLAG
              ;;
            "universal")
              echo "æž„å»ºé€šç”¨APK..."
              flutter build apk $BUILD_FLAG
              ;;
            "android-arm64")
              echo "æž„å»ºARM64 APK..."
              flutter build apk $BUILD_FLAG --target-platform android-arm64 --split-per-abi
              ;;
            "android-arm")
              echo "æž„å»ºARM APK..."
              flutter build apk $BUILD_FLAG --target-platform android-arm --split-per-abi
              ;;
            "android-x64")
              echo "æž„å»ºx64 APK..."
              flutter build apk $BUILD_FLAG --target-platform android-x64 --split-per-abi
              ;;
          esac
      
      - name: é‡å‘½åAPKæ–‡ä»¶
        run: |
          cd build/app/outputs/flutter-apk/
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          
          SUFFIX=""
          if [ -n "$VERSION_SUFFIX" ]; then
            SUFFIX="-$VERSION_SUFFIX"
          fi
          
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              # æå–æž¶æž„ä¿¡æ¯
              if [[ "$apk" == *"arm64-v8a"* ]]; then
                ARCH="arm64-v8a"
              elif [[ "$apk" == *"armeabi-v7a"* ]]; then
                ARCH="armeabi-v7a"
              elif [[ "$apk" == *"x86_64"* ]]; then
                ARCH="x86_64"
              else
                ARCH="universal"
              fi
              
              NEW_NAME="dont-poop-in-my-phone-${ARCH}-${BUILD_TYPE}${SUFFIX}.apk"
              mv "$apk" "$NEW_NAME"
              echo "é‡å‘½å: $apk -> $NEW_NAME"
            fi
          done
          
          ls -la
      
      - name: ä¸Šä¼ APKæž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: manual-build-apks-${{ github.event.inputs.build_type }}-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7
      
      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ”¨ æ‰‹åŠ¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºå‚æ•°:**" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡å¹³å°: ${{ github.event.inputs.target_platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬åŽç¼€: ${{ github.event.inputs.version_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆçš„APKæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
          cd build/app/outputs/flutter-apk/
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              SIZE=$(du -h "$apk" | cut -f1)
              echo "- $apk ($SIZE)" >> $GITHUB_STEP_SUMMARY
            fi
          done