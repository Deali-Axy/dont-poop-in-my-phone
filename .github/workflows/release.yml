name: æž„å»ºå¹¶å‘å¸ƒAPK

on:
  push:
    tags:
      - "v*.*.*"  # åŒ¹é… v1.0.0 æ ¼å¼çš„æ ‡ç­¾

jobs:
  build-apk:
    name: æž„å»ºå¤šæž¶æž„APK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target-platform:
          - android-arm64
          - android-arm
          - android-x64
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®JavaçŽ¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: è®¾ç½®FlutterçŽ¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
      
      - name: èŽ·å–Flutterä¾èµ–
        run: flutter pub get
      
      - name: è¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: æž„å»ºAPK - ${{ matrix.target-platform }}
        run: |
          case "${{ matrix.target-platform }}" in
            "android-arm64")
              flutter build apk --release --target-platform android-arm64 --split-per-abi
              ;;
            "android-arm")
              flutter build apk --release --target-platform android-arm --split-per-abi
              ;;
            "android-x64")
              flutter build apk --release --target-platform android-x64 --split-per-abi
              ;;
          esac
      
      - name: é‡å‘½åAPKæ–‡ä»¶
        run: |
          cd build/app/outputs/flutter-apk/
          case "${{ matrix.target-platform }}" in
            "android-arm64")
              if [ -f "app-arm64-v8a-release.apk" ]; then
                mv app-arm64-v8a-release.apk dont-poop-in-my-phone-arm64-v8a.apk
              fi
              ;;
            "android-arm")
              if [ -f "app-armeabi-v7a-release.apk" ]; then
                mv app-armeabi-v7a-release.apk dont-poop-in-my-phone-armeabi-v7a.apk
              fi
              ;;
            "android-x64")
              if [ -f "app-x86_64-release.apk" ]; then
                mv app-x86_64-release.apk dont-poop-in-my-phone-x86_64.apk
              fi
              ;;
          esac
      
      - name: ä¸Šä¼ APKæž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.target-platform }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 1

  build-universal-apk:
    name: æž„å»ºé€šç”¨APK
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®JavaçŽ¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: è®¾ç½®FlutterçŽ¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
      
      - name: èŽ·å–Flutterä¾èµ–
        run: flutter pub get
      
      - name: è¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: æž„å»ºé€šç”¨APK
        run: flutter build apk --release
      
      - name: é‡å‘½åé€šç”¨APK
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-release.apk dont-poop-in-my-phone-universal.apk
      
      - name: ä¸Šä¼ é€šç”¨APKæž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: apk-universal
          path: build/app/outputs/flutter-apk/dont-poop-in-my-phone-universal.apk
          retention-days: 1

  release:
    name: å‘å¸ƒåˆ°GitHub Release
    runs-on: ubuntu-latest
    needs: [build-apk, build-universal-apk]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: æå–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: ä¸‹è½½æ‰€æœ‰APKæž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: æ•´ç†APKæ–‡ä»¶
        run: |
          mkdir -p ./release-files
          find ./artifacts -name "*.apk" -exec cp {} ./release-files/ \;
          ls -la ./release-files/
      
      - name: è®¡ç®—APKæ–‡ä»¶å“ˆå¸Œ
        run: |
          cd ./release-files
          sha256sum *.apk > checksums.txt
          cat checksums.txt
      
      - name: åˆ›å»ºReleaseè¯´æ˜Ž
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸŽ‰ æ‰«åœ°å–µ v${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ
          
          ### ðŸ“± APKä¸‹è½½
          
          **æŽ¨èä¸‹è½½ï¼š**
          - `dont-poop-in-my-phone-universal.apk` - é€šç”¨ç‰ˆæœ¬ï¼Œé€‚ç”¨äºŽæ‰€æœ‰è®¾å¤‡
          
          **æŒ‰æž¶æž„ä¸‹è½½ï¼ˆæ–‡ä»¶æ›´å°ï¼‰ï¼š**
          - `dont-poop-in-my-phone-arm64-v8a.apk` - é€‚ç”¨äºŽçŽ°ä»£64ä½ARMè®¾å¤‡ï¼ˆæŽ¨èï¼‰
          - `dont-poop-in-my-phone-armeabi-v7a.apk` - é€‚ç”¨äºŽ32ä½ARMè®¾å¤‡
          - `dont-poop-in-my-phone-x86_64.apk` - é€‚ç”¨äºŽx86_64è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿå™¨ç­‰ï¼‰
          
          ### ðŸ”’ å®‰å…¨éªŒè¯
          è¯·ä¸‹è½½ `checksums.txt` æ–‡ä»¶éªŒè¯APKå®Œæ•´æ€§ã€‚
          
          ### ðŸ“‹ æ›´æ–°å†…å®¹
          è¯¦è§ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—ã€‚
          EOF
      
      - name: å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ./release-files/*.apk
            ./release-files/checksums.txt
          tag_name: ${{ github.ref }}
          name: æ‰«åœ°å–µ v${{ steps.get_version.outputs.VERSION }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false