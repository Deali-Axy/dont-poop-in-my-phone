# 扫地喵 (CleanerCat) 项目开发规则

## 项目概述

**项目名称**: 扫地喵 (CleanerCat)  
**技术栈**: Flutter 3.6.0+  
**目标平台**: Android  
**项目描述**: 智能清理App缓存垃圾，支持自动生成只读替身，防止流氓应用反复写入，还手机一片清净！

## 核心功能模块

- ✨ 智能识别常见垃圾目录
- 🧹 一键清理，快速释放空间  
- 🔒 清理后生成只读替身，防止垃圾再生
- 🧭 安全机制保障系统稳定不误删
- 👣 清理日志可视化，操作透明可控

## 技术架构规范

### 1. 项目结构

```
lib/
├── common/          # 全局配置和工具
├── dao/            # 数据访问层
├── database/       # 数据库定义和管理
├── models/         # 数据模型
├── pages/          # 页面组件
├── services/       # 业务服务层
├── states/         # 状态管理
├── utils/          # 工具类
├── viewmodels/     # 视图模型
└── widgets/        # 可复用组件
```

### 2. 核心依赖

- **状态管理**: Provider
- **数据库**: Drift (SQLite)
- **权限管理**: permission_handler
- **文件操作**: path_provider, file_picker
- **UI增强**: bot_toast, flutter_spinkit, animated_text_kit
- **网络请求**: dio
- **本地存储**: shared_preferences

## 代码规范

### 1. 命名规范

#### 文件命名
- 使用 `snake_case` 命名文件
- 页面文件以功能命名，如 `home.dart`, `clean.dart`
- 服务文件以 `_service.dart` 结尾
- 工具类文件放在 `utils/` 目录

#### 类命名
- 使用 `PascalCase` 命名类
- 页面类以 `Page` 结尾，如 `HomePage`
- 服务类以 `Service` 结尾，如 `CleanRuleService`
- 数据模型类使用简洁的名词，如 `Rule`, `Whitelist`
- Widget类使用描述性名称，如 `CatThemedAppBar`

#### 变量和方法命名
- 使用 `camelCase` 命名变量和方法
- 私有成员以下划线开头，如 `_hasPermission`
- 常量使用 `UPPER_SNAKE_CASE`，如 `SDCARD_ROOT`
- 布尔变量以 `is`, `has`, `can` 等开头

### 2. 代码组织

#### 导入顺序
1. Dart核心库
2. Flutter框架库
3. 第三方包
4. 项目内部模块（按层级顺序）

```dart
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../models/index.dart';
import '../services/index.dart';
```

#### 类结构顺序
1. 静态常量
2. 实例变量
3. 构造函数
4. 生命周期方法
5. 公共方法
6. 私有方法
7. 静态方法

### 3. UI/UX 规范

#### 主题设计
- 支持深色/浅色主题切换
- 使用Material 3设计规范
- 猫咪主题元素贯穿整个应用
- 使用emoji增强用户体验 (🐱, ✨, 🧹, 🔒, 🧭, 👣)

#### 组件规范
- 优先使用项目自定义组件，如 `CatThemedAppBar`
- 统一使用 `BotToast` 进行消息提示
- 加载状态使用 `flutter_spinkit`
- 动画效果使用 `animated_text_kit` 和 `flutter_staggered_animations`

#### 响应式设计
- 支持不同屏幕尺寸
- 使用 `MediaQuery` 获取屏幕信息
- 合理使用 `Flexible` 和 `Expanded`

### 4. 数据管理规范

#### 数据库设计
- 使用 Drift 进行数据库操作
- 表名使用复数形式，如 `WhitelistEntities`
- 字段命名使用 `camelCase`
- 必须包含 `createdAt` 和 `updatedAt` 时间戳
- 使用外键约束保证数据完整性

#### 数据访问层 (DAO)
- 每个实体对应一个DAO类
- DAO类提供CRUD基础操作
- 复杂查询封装为具名方法
- 使用事务保证数据一致性

#### 状态管理
- 使用 Provider 进行状态管理
- 主题状态通过 `ThemeState` 管理
- 全局配置通过 `Global` 类管理
- 避免过度使用 `setState`

### 5. 业务逻辑规范

#### 文件系统操作
- 所有文件操作必须检查权限
- 使用 `StarFileSystem` 工具类进行文件操作
- 路径操作使用 `path` 包
- 危险操作必须有安全检查机制

#### 清理规则
- 规则配置通过数据库管理
- 支持正则表达式和通配符匹配
- 清理操作必须记录日志
- 提供撤销机制

#### 权限管理
- 使用 `permission_handler` 管理权限
- 权限检查在操作前进行
- 提供权限说明和引导
- 优雅处理权限拒绝情况

### 6. 错误处理规范

#### 全局错误处理
- 使用 `ErrorHandler` 统一处理错误
- Flutter错误通过 `FlutterError.onError` 捕获
- 网络错误提供重试机制
- 文件操作错误提供详细说明

#### 用户友好的错误提示
- 使用中文错误消息
- 提供解决方案建议
- 避免技术术语
- 使用 `BotToast` 显示错误信息

### 7. 性能优化规范

#### 列表优化
- 长列表使用 `ListView.builder`
- 实现滚动位置记忆
- 合理使用 `ScrollController`
- 避免不必要的重建

#### 内存管理
- 及时释放资源
- 避免内存泄漏
- 合理使用缓存
- 监控内存使用情况

#### 异步操作
- 使用 `Future` 和 `async/await`
- 避免阻塞UI线程
- 合理使用 `Isolate`
- 提供加载状态指示

## 开发工作流

### 1. 功能开发流程

1. **需求分析**: 明确功能需求和用户场景
2. **设计评审**: 确定技术方案和UI设计
3. **数据建模**: 设计数据结构和数据库表
4. **接口定义**: 定义服务接口和数据模型
5. **功能实现**: 按模块实现功能
6. **测试验证**: 单元测试和集成测试
7. **代码审查**: 代码质量和规范检查
8. **文档更新**: 更新相关文档

### 2. 代码提交规范

#### 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

#### 类型说明
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建或工具相关

#### 示例
```
feat(clean): 添加只读替身生成功能

- 实现清理后自动创建只读文件
- 添加替身文件状态检查
- 优化清理性能

Closes #123
```

### 3. 测试策略

#### 单元测试
- 核心业务逻辑必须有单元测试
- 工具类方法必须有测试覆盖
- 数据模型转换测试
- 使用 `flutter_test` 框架

#### 集成测试
- 关键用户流程测试
- 数据库操作测试
- 权限相关功能测试
- 文件操作安全性测试

#### 性能测试
- 大量文件处理性能
- 内存使用监控
- 启动时间优化
- 电池消耗测试

## 安全规范

### 1. 文件操作安全
- 严格检查文件路径合法性
- 禁止操作系统关键目录
- 实现白名单保护机制
- 提供操作撤销功能

### 2. 权限最小化
- 只申请必要权限
- 运行时权限检查
- 权限使用说明
- 优雅降级处理

### 3. 数据保护
- 敏感数据加密存储
- 避免日志泄露信息
- 用户数据本地化
- 定期清理临时文件

## 国际化规范

### 1. 文本外部化
- 所有用户可见文本使用国际化
- 使用 `intl` 包管理多语言
- 支持中文和英文
- 考虑文本长度变化

### 2. 文化适配
- 日期时间格式本地化
- 数字格式本地化
- 颜色和图标文化适配
- 阅读习惯适配

## AI开发助手使用指南

### 1. 代码生成要求

当AI助手为本项目生成代码时，必须遵循以下规则：

#### 基础要求
- 严格遵循上述所有代码规范
- 使用项目已有的依赖包，避免引入新依赖
- 保持与现有代码风格一致
- 添加必要的中文注释

#### 文件操作相关
- 任何文件操作都必须包含权限检查
- 使用 `StarFileSystem` 工具类
- 实现适当的错误处理
- 添加操作日志记录

#### UI组件开发
- 优先使用项目现有组件
- 遵循猫咪主题设计
- 支持深色/浅色主题
- 使用Material 3设计规范
- 添加适当的动画效果

#### 数据库操作
- 使用Drift框架
- 遵循现有表结构设计
- 包含时间戳字段
- 使用事务保证一致性

### 2. 代码审查要点

AI助手在审查代码时应关注：

#### 安全性检查
- 文件路径验证
- 权限检查完整性
- 输入数据验证
- 错误处理覆盖

#### 性能考虑
- 避免UI线程阻塞
- 合理使用异步操作
- 内存泄漏检查
- 列表性能优化

#### 用户体验
- 加载状态指示
- 错误信息友好性
- 操作反馈及时性
- 界面响应性

### 3. 问题排查指南

#### 常见问题类型
1. **权限问题**: 检查权限申请和使用
2. **文件操作失败**: 验证路径和权限
3. **数据库错误**: 检查表结构和约束
4. **UI渲染问题**: 检查状态管理和生命周期
5. **性能问题**: 分析异步操作和内存使用

#### 调试建议
- 使用 `print` 或 `debugPrint` 输出调试信息
- 利用Flutter Inspector分析UI结构
- 使用Performance工具监控性能
- 检查设备日志获取详细错误信息

### 4. 功能扩展指导

#### 新功能开发
1. 评估对现有架构的影响
2. 确定数据模型变更需求
3. 设计用户界面和交互
4. 实现业务逻辑和数据访问
5. 添加错误处理和日志
6. 编写测试用例
7. 更新文档

#### 重构建议
- 保持向后兼容性
- 分步骤进行重构
- 充分测试重构结果
- 更新相关文档

## 版本管理

### 1. 版本号规范
- 遵循语义化版本控制 (SemVer)
- 格式: `MAJOR.MINOR.PATCH+BUILD`
- 当前版本: `1.4.4+22`

### 2. 发布流程
1. 功能开发完成
2. 测试验证通过
3. 更新版本号
4. 生成发布说明
5. 创建发布标签
6. 构建发布包
7. 发布到应用商店

---

**最后更新**: 2025-6-5
**维护者**: CleanerCat开发团队

> 本规则文档是活文档，会根据项目发展持续更新。所有开发者和AI助手都应严格遵循这些规范，确保项目代码质量和一致性。