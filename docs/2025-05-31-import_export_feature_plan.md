# Context
Filename: 2025-01-02-import_export_feature_plan.md
Created On: 2025-01-02
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
请给白名单、清理规则、路径标注功能增加导入导出功能

# Project Overview
这是一个Flutter应用，用于清理手机中的垃圾文件。项目包含三个主要功能模块：
1. 白名单管理 (Whitelist) - 保护重要文件/目录不被清理
2. 清理规则管理 (Rule/RuleItem) - 定义文件清理的规则和策略
3. 路径标注管理 (PathAnnotation) - 为路径添加描述和清理建议

项目使用Drift数据库进行数据持久化，已有完整的DAO层和模型层。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 现有技术栈分析
- **数据库**: 使用Drift ORM，所有模型都有完整的toJson/fromJson方法
- **数据模型**: 
  - Whitelist: 包含path, type, annotation, readOnly等字段
  - Rule/RuleItem: 包含规则组和规则项，支持复杂的清理逻辑
  - PathAnnotation: 包含path, description, suggestDelete等字段
- **现有导入导出**: CleanConfigManager已实现配置的导入导出功能
- **依赖包**: 项目已有path_provider, shared_preferences等基础包，但缺少file_picker

## 数据结构分析
1. **Whitelist模型**:
   - 核心字段: path, type(enum), annotation, readOnly
   - 支持JSON序列化
   - 有完整的DAO层支持

2. **Rule/RuleItem模型**:
   - Rule: 规则组，包含name, rules列表, isSystemRule
   - RuleItem: 具体规则，包含path, pathMatchType, actionType, priority等
   - 复杂的层级结构，需要特殊处理

3. **PathAnnotation模型**:
   - 核心字段: path, description, suggestDelete, isBuiltIn, pathMatchType
   - 支持JSON序列化
   - 有完整的DAO层支持

## 现有UI模式分析
- 项目使用Material Design
- 已有对话框、列表页面等UI组件
- clean_settings_widget.dart中已有导出配置的UI实现模式

## 技术约束
- 需要添加file_picker依赖包
- 需要处理文件权限问题
- 需要考虑数据完整性和版本兼容性
- 系统规则(isSystemRule=true)不应被导入覆盖

# Proposed Solution (Populated by INNOVATE mode)

## 解决方案设计

### 方案1: 统一JSON格式导入导出
**优点**:
- 使用现有的JSON序列化基础设施
- 格式简单，易于理解和调试
- 可以包含元数据信息

**缺点**:
- 文件可能较大
- 不易于在其他工具中编辑

### 方案2: CSV格式导入导出
**优点**:
- 文件小，易于在Excel等工具中编辑
- 适合批量数据处理

**缺点**:
- 需要额外的CSV解析逻辑
- 复杂数据结构(如Rule的层级关系)难以表示

### 方案3: 混合方案
**优点**:
- JSON用于完整备份，CSV用于批量编辑
- 灵活性最高

**缺点**:
- 实现复杂度较高

## 推荐方案: 统一JSON格式
基于项目现有基础设施和数据复杂性，推荐使用JSON格式，原因：
1. 项目已有完整的JSON序列化支持
2. 可以保持数据完整性
3. 支持复杂的数据结构
4. 与现有的配置导入导出模式一致

## 功能设计

### 导出功能
1. **单独导出**: 每个模块独立导出
2. **批量导出**: 支持选择多个模块一起导出
3. **完整备份**: 导出所有数据

### 导入功能
1. **增量导入**: 添加新数据，不覆盖现有数据
2. **覆盖导入**: 完全替换现有数据
3. **智能合并**: 根据路径等关键字段智能合并

### 数据格式设计
```json
{
  "version": "1.0",
  "exportTime": "2025-01-02T10:00:00Z",
  "appVersion": "1.4.1",
  "data": {
    "whitelists": [...],
    "rules": [...],
    "pathAnnotations": [...]
  }
}
```

# Implementation Plan (Generated by PLAN mode)

## 详细实现计划

### 第一阶段: 添加依赖和基础服务
1. **添加file_picker依赖**
   - 在pubspec.yaml中添加file_picker包
   - 运行flutter pub get

2. **创建导入导出服务类**
   - 创建 `lib/services/import_export_service.dart`
   - 实现数据序列化/反序列化逻辑
   - 实现文件读写功能

### 第二阶段: 实现核心导入导出逻辑
3. **实现白名单导入导出**
   - 在ImportExportService中添加白名单相关方法
   - exportWhitelists() - 导出白名单数据
   - importWhitelists() - 导入白名单数据

4. **实现清理规则导入导出**
   - exportRules() - 导出规则数据
   - importRules() - 导入规则数据，需要处理规则组层级关系

5. **实现路径标注导入导出**
   - exportPathAnnotations() - 导出路径标注数据
   - importPathAnnotations() - 导入路径标注数据

6. **实现统一导入导出**
   - exportAll() - 导出所有数据
   - importAll() - 导入所有数据

### 第三阶段: UI组件实现
7. **创建导入导出对话框组件**
   - 创建 `lib/widgets/import_export_dialog.dart`
   - 支持选择导入导出类型
   - 支持选择导入模式(增量/覆盖)

8. **在白名单页面添加导入导出按钮**
   - 修改 `lib/pages/whitelist.dart`
   - 在AppBar或FloatingActionButton中添加导入导出功能

9. **在规则页面添加导入导出按钮**
   - 修改 `lib/pages/rule.dart`
   - 添加导入导出功能

10. **在路径标注页面添加导入导出按钮**
    - 修改 `lib/pages/path_annotation_page.dart`
    - 添加导入导出功能

### 第四阶段: 错误处理和优化
11. **添加错误处理**
    - 文件格式验证
    - 数据完整性检查
    - 用户友好的错误提示

12. **添加进度指示**
    - 导入导出过程中显示进度
    - 大数据量时的性能优化

13. **添加确认对话框**
    - 导入前显示数据预览
    - 覆盖导入时的警告确认

## Implementation Checklist:
1. ✅ 在pubspec.yaml中添加file_picker依赖
2. ✅ 创建ImportExportService服务类，包含基础的文件操作方法
3. ✅ 实现白名单数据的导入导出方法
4. ✅ 实现清理规则数据的导入导出方法
5. ✅ 实现路径标注数据的导入导出方法
6. ✅ 实现统一的全量导入导出方法
7. ✅ 创建ImportExportDialog组件，提供用户界面
8. ✅ 在白名单页面(whitelist.dart)添加导入导出按钮和功能
9. ✅ 在规则页面(rule.dart)添加导入导出按钮和功能
10. ✅ 在路径标注页面(path_annotation_page.dart)添加导入导出按钮和功能
11. ✅ 添加数据验证和错误处理逻辑
12. ✅ 添加导入导出过程的进度指示和用户反馈
13. ⏳ 测试所有导入导出功能，确保数据完整性

## 实施状态

### 已完成功能

**核心服务实现**：
- ✅ ImportExportService服务类已创建，包含完整的导入导出逻辑
- ✅ 支持白名单、清理规则、路径标注的单独导入导出
- ✅ 支持全量数据备份与恢复
- ✅ 实现三种导入模式：智能合并、增量导入、覆盖导入
- ✅ 完整的数据验证和错误处理机制

**UI组件实现**：
- ✅ ImportExportDialog对话框组件已创建
- ✅ ImportExportDialogHelper便捷调用方法已实现
- ✅ 支持导入模式选择的用户界面
- ✅ 完整的成功/失败反馈机制

**页面集成**：
- ✅ 白名单页面：添加导入导出按钮，替换原有TODO功能
- ✅ 清理规则页面：添加导入导出按钮
- ✅ 路径标注页面：添加导入导出按钮
- ✅ 清理设置页面：添加数据备份与恢复功能

**技术特性**：
- ✅ JSON格式数据交换，包含版本信息和时间戳
- ✅ 自动跳过系统数据和只读数据的导入
- ✅ 智能路径匹配和重复数据检测
- ✅ 文件选择器集成，支持JSON文件过滤
- ✅ 导出文件自动命名和路径管理

### 当前状态

所有核心功能已实现完成，包括：
1. 完整的导入导出服务架构
2. 用户友好的对话框界面
3. 所有相关页面的UI集成
4. 完善的错误处理和用户反馈

**下一步**：进行功能测试，确保所有导入导出功能正常工作。

# Current Execution Step (Updated by EXECUTE mode when starting a step)

# Task Progress (Appended by EXECUTE mode after each step completion)

# Final Review (Populated by REVIEW mode)